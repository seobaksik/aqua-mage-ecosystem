name: CI/CD Pipeline for Aqua Mage Ecosystem

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  # ğŸ”§ ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ¿: Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  validate-and-test:
    name: ğŸ§ª Validate & Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â” Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install root dependencies
      run: npm install
    
    - name: ğŸ”— Bootstrap packages with Lerna
      run: npx lerna bootstrap --ci
    
    - name: ğŸ” TypeScript type checking
      run: |
        cd packages/am-passid
        npx tsc --noEmit --project tsconfig.json
    
    - name: ğŸ§ª Run tests
      run: npx lerna run test --stream
    
    - name: ğŸ—ï¸ Build packages
      run: npx lerna run build --stream
    
    - name: ğŸ“Š Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        directory: ./packages/am-passid/coverage

  # ğŸš€ Ğ’Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑÑ‚Ğ°Ğ¿: ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸)
  publish-package:
    name: ğŸš€ Publish to npm
    needs: validate-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: â” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org/'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        npx lerna bootstrap --ci
    
    - name: ğŸ—ï¸ Build all packages
      run: npx lerna run build --stream
    
    - name: ğŸš€ Publish @aquamage/am-passid
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: |
        cd packages/am-passid
        npm publish --access public
